<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Â· ç®¡ç†åå°</title>
    <!-- ä½¿ç”¨å’Œä¹‹å‰ç›¸åŒçš„ CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        body { 
            background: linear-gradient(145deg, #f1f5f9 0%, #e6edf5 100%);
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(43, 110, 155, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar h2 {
            color: #1e405e;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
            background: white;
            padding: 8px;
            border-radius: 60px;
            box-shadow: 0 10px 25px -8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(43, 110, 155, 0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 14px 28px;
            border-radius: 60px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .tab-btn.active {
            background: #2b6e9b;
            color: white;
            box-shadow: 0 8px 20px -8px rgba(43, 110, 155, 0.5);
        }
        
        .panel {
            background: white;
            border-radius: 32px;
            padding: 32px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(43, 110, 155, 0.1);
            transition: transform 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
        }
        
        .panel h3 {
            color: #1e405e;
            font-size: 1.5rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9f0f5;
        }
        
        .panel h4 {
            color: #2b6e9b;
            font-size: 1.2rem;
            margin: 30px 0 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
        }
        
        th {
            text-align: left;
            padding: 16px 12px;
            background: #f8fafc;
            color: #1e405e;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e9f0f5;
            color: #475569;
        }
        
        tr:hover td {
            background: #f8fafc;
        }
        
        input, select {
            padding: 12px 20px;
            border-radius: 40px;
            border: 2px solid #e2e8f0;
            width: 100%;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
            background: white;
        }
        
        input:focus, select:focus {
            border-color: #2b6e9b;
            box-shadow: 0 0 0 4px rgba(43, 110, 155, 0.1);
        }
        
        .btn {
            background: #2b6e9b;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(43, 110, 155, 0.2);
            font-size: 0.95rem;
        }
        
        .btn:hover {
            background: #1d4f73;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(43, 110, 155, 0.3);
        }
        
        .btn-danger {
            background: #b91c1c;
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.2);
            padding: 8px 20px;
            font-size: 0.9rem;
        }
        
        .btn-danger:hover {
            background: #7f1515;
            box-shadow: 0 8px 20px rgba(185, 28, 28, 0.3);
        }
        
        .btn-group {
            display: flex;
            gap: 16px;
            margin: 25px 0 10px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8fafc;
            padding: 24px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .btn-group input, .btn-group select {
            flex: 1;
            min-width: 200px;
        }
        
        .time-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }
        
        .time-input-group input {
            flex: 1;
            min-width: 100px;
        }
        
        .time-separator {
            color: #64748b;
            font-weight: 600;
        }
        
        .hidden {
            display: none;
        }
        
        .message {
            color: #b91c1c;
            margin: 15px 0;
            padding: 12px 20px;
            background: #fef2f2;
            border-radius: 40px;
            border: 1px solid #fecaca;
            font-size: 0.95rem;
        }
        
        .success {
            color: #2b6e9b;
            padding: 12px 20px;
            background: #e6f0f7;
            border-radius: 40px;
            border: 1px solid #c1d9ec;
            margin: 10px 0;
        }
        
        .password-cell {
            cursor: pointer;
            user-select: none;
            padding: 8px 0;
        }
        
        .password-hidden {
            font-family: monospace;
            background: #f1f5f9;
            padding: 8px 16px;
            border-radius: 30px;
            color: #94a3b8;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .password-hidden:hover {
            background: #e2e8f0;
        }
        
        .password-visible {
            font-family: monospace;
            background: #f1f5f9;
            padding: 8px 16px;
            border-radius: 30px;
            color: #0f172a;
            display: inline-block;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h2>shiâ€†guan DCC ç®¡ç†åå°</h2>
        <button class="btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="courses">ğŸ“… æ’è¯¾ç®¡ç†</button>
            <button class="tab-btn" data-tab="instructors">ğŸ‘¥ è®²å¸ˆç®¡ç†</button>
            <button class="tab-btn" data-tab="users">ğŸ‘¤ å­¦å‘˜ç®¡ç†</button>
            <button class="tab-btn" data-tab="registrations">ğŸ“‹ æŠ¥ååˆ—è¡¨</button>
        </div>

        <!-- æ’è¯¾ç®¡ç†é¢æ¿ -->
        <div class="panel" id="coursesPanel">
            <h3>ğŸ“… è¯¾ç¨‹åˆ—è¡¨</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ—¶é—´</th>
                        <th>è®²å¸ˆ</th>
                        <th>è¯¾ç¨‹åç§°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="coursesTable">
                    <tr><td colspan="5" style="text-align:center; padding:40px;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
            
            <h4>â• æ–°å¢è¯¾ç¨‹</h4>
            <div class="btn-group">
                <input type="date" id="newCourseDate" style="flex:1;">
                
                <!-- æ—¶é—´æ®µé€‰æ‹© -->
                <div class="time-input-group">
                    <input type="time" id="newStartTime" value="15:30" style="flex:1;">
                    <span class="time-separator">è‡³</span>
                    <input type="time" id="newEndTime" value="17:00" style="flex:1;">
                </div>
                
                <select id="newCourseInstructor" style="flex:1;">
                    <option value="">é€‰æ‹©è®²å¸ˆ</option>
                </select>
                
                <input type="text" id="newCourseName" placeholder="è¯¾ç¨‹åç§°" style="flex:1;">
                <button class="btn" id="addCourseBtn">æ·»åŠ è¯¾ç¨‹</button>
            </div>
            <div id="courseMessage" class="message"></div>
        </div>

        <!-- è®²å¸ˆç®¡ç†é¢æ¿ -->
        <div class="panel hidden" id="instructorsPanel">
            <h3>ğŸ‘¥ è®²å¸ˆåˆ—è¡¨</h3>
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ä¸“é•¿</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="instructorsTable">
                    <tr><td colspan="3" style="text-align:center; padding:40px;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
            
            <h4>â• æ·»åŠ è®²å¸ˆ</h4>
            <div class="btn-group">
                <input type="text" id="newInstName" placeholder="è®²å¸ˆå§“å">
                <input type="text" id="newInstSpecialty" placeholder="ä¸“é•¿">
                <button class="btn" id="addInstructorBtn">æ·»åŠ è®²å¸ˆ</button>
            </div>
            <div id="instructorMessage" class="message"></div>
        </div>

        <!-- å­¦å‘˜ç®¡ç†é¢æ¿ -->
        <div class="panel hidden" id="usersPanel">
            <h3>ğŸ‘¤ å­¦å‘˜åˆ—è¡¨</h3>
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å¯†ç </th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr><td colspan="3" style="text-align:center; padding:40px;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
            <div id="userMessage" class="message"></div>
        </div>

        <!-- æŠ¥ååˆ—è¡¨é¢æ¿ -->
        <div class="panel hidden" id="registrationsPanel">
            <h3>ğŸ“‹ æ‰€æœ‰æŠ¥åè®°å½•</h3>
            <table>
                <thead>
                    <tr>
                        <th>å­¦å‘˜</th>
                        <th>è¯¾ç¨‹</th>
                        <th>æ—¥æœŸ</th>
                        <th>æ—¶é—´</th>
                        <th>è®²å¸ˆ</th>
                        <th>æŠ¥åæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="registrationsTable">
                    <tr><td colspan="7" style="text-align:center; padding:40px;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fdwacsuphbpxfariohan.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd2Fjc3VwaGJweGZhcmlvaGFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMDM1MzcsImV4cCI6MjA4NjY3OTUzN30.q1CzBhIw8xVYL4efkTvGYLkeC04dnBSCPcAWk7LHxxU';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        if (sessionStorage.getItem('userRole') !== 'admin') {
            window.location.href = 'index.html';
        }

        let visiblePasswords = {};

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(this.dataset.tab + 'Panel').classList.remove('hidden');
                
                if (this.dataset.tab === 'instructors') {
                    loadInstructors();
                } else if (this.dataset.tab === 'courses') {
                    loadCourses();
                } else if (this.dataset.tab === 'users') {
                    loadUsers();
                } else if (this.dataset.tab === 'registrations') {
                    loadRegistrations();
                }
            };
        });

        window.onload = function() {
            loadInstructors();
            loadCourses();
            loadUsers();
            loadRegistrations();
        };

        function togglePassword(userId) {
            visiblePasswords[userId] = !visiblePasswords[userId];
            loadUsers();
        }

        async function loadUsers() {
            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('role', 'student')
                .order('id');
            
            if (error) {
                document.getElementById('usersTable').innerHTML = `<tr><td colspan="3" style="color:red; padding:40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
                return;
            }
            
            const tbody = document.getElementById('usersTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:40px;">æš‚æ— å­¦å‘˜</td></tr>';
            } else {
                let html = '';
                data.forEach(user => {
                    const isVisible = visiblePasswords[user.id] || false;
                    
                    html += `<tr>
                        <td>${user.name}</td>
                        <td class="password-cell" onclick="togglePassword('${user.id}')">
                            ${isVisible 
                                ? `<span class="password-visible">${user.password}</span>` 
                                : `<span class="password-hidden">â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>`}
                        </td>
                        <td><button class="btn-danger btn" onclick="deleteUser('${user.id}')">åˆ é™¤</button></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            }
        }

        window.deleteUser = async function(id) {
            const { error } = await supabaseClient
                .from('users')
                .delete()
                .eq('id', id);
            
            if (error) {
                document.getElementById('userMessage').innerText = 'åˆ é™¤å¤±è´¥ï¼š' + error.message;
            } else {
                document.getElementById('userMessage').innerText = 'âœ… åˆ é™¤æˆåŠŸ';
                delete visiblePasswords[id];
                loadUsers();
            }
        };

        async function loadInstructors() {
            const { data, error } = await supabaseClient
                .from('instructors')
                .select('*')
                .order('id');
            
            if (error) {
                document.getElementById('instructorsTable').innerHTML = `<tr><td colspan="3" style="color:red; padding:40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
                return;
            }
            
            const tbody = document.getElementById('instructorsTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:40px;">æš‚æ— è®²å¸ˆï¼Œè¯·æ·»åŠ </td></tr>';
            } else {
                let html = '';
                data.forEach(inst => {
                    html += `<tr>
                        <td>${inst.name}</td>
                        <td>${inst.specialty}</td>
                        <td><button class="btn-danger btn" onclick="deleteInstructor('${inst.id}')">åˆ é™¤</button></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            }
            
            const select = document.getElementById('newCourseInstructor');
            select.innerHTML = '<option value="">é€‰æ‹©è®²å¸ˆ</option>';
            if (data) {
                data.forEach(inst => {
                    select.innerHTML += `<option value="${inst.id}">${inst.name}</option>`;
                });
            }
        }

        window.deleteInstructor = async function(id) {
            const { error } = await supabaseClient
                .from('instructors')
                .delete()
                .eq('id', id);
            
            if (error) {
                document.getElementById('instructorMessage').innerText = 'åˆ é™¤å¤±è´¥ï¼š' + error.message;
            } else {
                document.getElementById('instructorMessage').innerText = 'âœ… åˆ é™¤æˆåŠŸ';
                loadInstructors();
                loadCourses();
            }
        };

        document.getElementById('addInstructorBtn').onclick = async function() {
            const name = document.getElementById('newInstName').value.trim();
            const specialty = document.getElementById('newInstSpecialty').value.trim();
            
            if (!name || !specialty) {
                document.getElementById('instructorMessage').innerText = 'è¯·å¡«å†™å®Œæ•´';
                return;
            }
            
            const { error } = await supabaseClient
                .from('instructors')
                .insert([{ name, specialty }]);
            
            if (error) {
                document.getElementById('instructorMessage').innerText = 'æ·»åŠ å¤±è´¥ï¼š' + error.message;
            } else {
                document.getElementById('newInstName').value = '';
                document.getElementById('newInstSpecialty').value = '';
                document.getElementById('instructorMessage').innerText = 'âœ… æ·»åŠ æˆåŠŸ';
                loadInstructors();
            }
        };

        async function loadCourses() {
            const { data, error } = await supabaseClient
                .from('courses')
                .select('*, instructors(*)')
                .order('date');
            
            if (error) {
                document.getElementById('coursesTable').innerHTML = `<tr><td colspan="5" style="color:red; padding:40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
                return;
            }
            
            const tbody = document.getElementById('coursesTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px;">æš‚æ— è¯¾ç¨‹</td></tr>';
            } else {
                let html = '';
                data.forEach(c => {
                    // è§£ææ—¶é—´æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤
                    const timeRange = c.time_range || '15:30-17:00';
                    
                    html += `<tr>
                        <td>${c.date}</td>
                        <td>${timeRange}</td>
                        <td>${c.instructors?.name || 'æœªçŸ¥'}</td>
                        <td>${c.course_name}</td>
                        <td><button class="btn-danger btn" onclick="deleteCourse('${c.id}')">åˆ é™¤</button></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            }
        }

        window.deleteCourse = async function(id) {
            const { error } = await supabaseClient
                .from('courses')
                .delete()
                .eq('id', id);
            
            if (error) {
                document.getElementById('courseMessage').innerText = 'åˆ é™¤å¤±è´¥ï¼š' + error.message;
            } else {
                document.getElementById('courseMessage').innerText = 'âœ… åˆ é™¤æˆåŠŸ';
                loadCourses();
            }
        };

        document.getElementById('addCourseBtn').onclick = async function() {
            const date = document.getElementById('newCourseDate').value;
            const startTime = document.getElementById('newStartTime').value;
            const endTime = document.getElementById('newEndTime').value;
            const instructor_id = document.getElementById('newCourseInstructor').value;
            const course_name = document.getElementById('newCourseName').value.trim();
            
            if (!date || !startTime || !endTime || !instructor_id || !course_name) {
                document.getElementById('courseMessage').innerText = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
                return;
            }
            
            // ç»„åˆæ—¶é—´æ®µ
            const time_range = `${startTime}-${endTime}`;
            
            const { error } = await supabaseClient
                .from('courses')
                .insert([{ 
                    date, 
                    time_range,
                    instructor_id, 
                    course_name 
                }]);
            
            if (error) {
                document.getElementById('courseMessage').innerText = 'æ·»åŠ å¤±è´¥ï¼š' + error.message;
            } else {
                document.getElementById('newCourseDate').value = '';
                document.getElementById('newStartTime').value = '15:30';
                document.getElementById('newEndTime').value = '17:00';
                document.getElementById('newCourseName').value = '';
                document.getElementById('courseMessage').innerText = 'âœ… æ·»åŠ æˆåŠŸ';
                loadCourses();
            }
        };

        async function loadRegistrations() {
            const { data, error } = await supabaseClient
                .from('registrations')
                .select('*, courses(*, instructors(*)), users(name)')
                .order('registered_at', { ascending: false });
            
            if (error) {
                document.getElementById('registrationsTable').innerHTML = `<tr><td colspan="7" style="color:red; padding:40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
                return;
            }
            
            const tbody = document.getElementById('registrationsTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px;">æš‚æ— æŠ¥åè®°å½•</td></tr>';
            } else {
                let html = '';
                data.forEach(r => {
                    const timeRange = r.courses?.time_range || '15:30-17:00';
                    
                    html += `<tr>
                        <td>${r.users?.name || r.student_name}</td>
                        <td>${r.courses?.course_name || '--'}</td>
                        <td>${r.courses?.date || '--'}</td>
                        <td>${timeRange}</td>
                        <td>${r.courses?.instructors?.name || '--'}</td>
                        <td>${new Date(r.registered_at).toLocaleString()}</td>
                        <td><button class="btn-danger btn" onclick="deleteRegistration('${r.id}')">åˆ é™¤</button></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            }
        }

        // åˆ é™¤æŠ¥åè®°å½• - æ— ç¡®è®¤æ¡†
        window.deleteRegistration = async function(id) {
            const { error } = await supabaseClient
                .from('registrations')
                .delete()
                .eq('id', id);
            
            if (error) {
                document.getElementById('registrationsTable').innerHTML = `<tr><td colspan="7" style="color:red; padding:40px;">åˆ é™¤å¤±è´¥ï¼š${error.message}</td></tr>`;
            } else {
                // é‡æ–°åŠ è½½æŠ¥ååˆ—è¡¨
                loadRegistrations();
            }
        };

        document.getElementById('logoutBtn').onclick = function() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>
